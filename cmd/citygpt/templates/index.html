{{- /*
Copyright 2025 Marc-Antoine Ruel and FÃ©lix Lachapelle. All rights reserved.
Use of this source code is governed under the AGPL v3
that can be found in the LICENSE file.
*/ -}}
{{- define "extra_css" -}}
<style>
	:root {
		--user-msg-color: #4361ee;
		--user-msg-text: #fff;
		--bot-msg-color: #f2f5ff;
		--bot-msg-text: #333;
	}

	.container {
		flex: 1;
		padding: 20px;
		display: flex;
		flex-direction: column;
		height: calc(100vh - 70px);
		max-height: 100%;
	}

	#reset-button {
		width: 38px;
		height: 38px;
		background: rgba(255, 255, 255, 0.2);
		border: none;
		border-radius: 50%;
		color: white;
		cursor: pointer;
		display: flex;
		align-items: center;
		justify-content: center;
		transition: background-color 0.3s;
		flex-shrink: 0;
		margin-left: 10px;
	}

	#reset-button:hover {
		background-color: rgba(255, 255, 255, 0.3);
	}

	#chat-container {
		flex: 1 1 auto;
		overflow-y: auto;
		padding: 20px;
		background: white;
		border-radius: 10px;
		box-shadow: 0 2px 20px rgba(0, 0, 0, 0.05);
		margin-bottom: 20px;
		scroll-behavior: smooth;
		min-height: 100px;
		/* Ensure minimum height even on small screens */
	}

	.message-row {
		display: flex;
		margin-bottom: 20px;
		position: relative;
	}

	.message-row.user {
		justify-content: flex-end;
	}

	.avatar {
		width: 36px;
		height: 36px;
		border-radius: 50%;
		background-color: var(--primary-light);
		display: flex;
		align-items: center;
		justify-content: center;
		margin-right: 12px;
		font-size: 1rem;
		color: var(--primary-color);
	}

	.message-row.user .avatar {
		order: 1;
		margin-right: 0;
		margin-left: 12px;
		background-color: var(--primary-color);
		color: white;
	}

	.message {
		max-width: 70%;
		padding: 12px 16px;
		border-radius: 18px;
		position: relative;
		animation: fadeIn 0.3s ease-out;
		box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
	}

	.message-content {
		white-space: pre-wrap;
		word-wrap: break-word;
	}

	.message-content a {
		color: #2563eb;
		font-weight: 500;
		text-decoration: none;
		border-bottom: 1px solid rgba(37, 99, 235, 0.3);
		transition: border-color 0.2s, color 0.2s;
	}

	.message-content a:hover {
		color: #1e40af;
		border-bottom-color: rgba(30, 64, 175, 0.7);
	}

	.message-content a:first-child {
		display: inline-block;
		padding: 6px 12px;
		background-color: rgba(37, 99, 235, 0.1);
		border-radius: 6px;
		border-bottom: none;
		margin-bottom: 8px;
		transition: background-color 0.2s;
	}

	.message-content a:first-child:hover {
		background-color: rgba(37, 99, 235, 0.2);
	}

	@keyframes fadeIn {
		from {
			opacity: 0;
			transform: translateY(10px);
		}

		to {
			opacity: 1;
			transform: translateY(0);
		}
	}

	.user-message {
		background-color: var(--user-msg-color);
		color: var(--user-msg-text);
		border-top-right-radius: 4px;
	}

	.assistant-message {
		background-color: var(--bot-msg-color);
		color: var(--bot-msg-text);
		border-top-left-radius: 4px;
	}

	.message-time {
		font-size: 0.7rem;
		color: var(--dark-gray);
		margin-top: 5px;
		text-align: right;
		opacity: 0.8;
	}

	.message-row.user .message-time {
		text-align: right;
	}

	#input-container {
		display: flex;
		padding: 15px;
		background: white;
		border-radius: 10px;
		box-shadow: 0 2px 20px rgba(0, 0, 0, 0.05);
	}

	#message-input {
		flex-grow: 1;
		padding: 14px 20px;
		border: 1px solid var(--light-gray);
		border-radius: 30px;
		font-family: 'Inter', sans-serif;
		font-size: 1rem;
		outline: none;
		transition: border-color 0.3s, box-shadow 0.3s;
	}

	#message-input:focus {
		border-color: var(--primary-color);
		box-shadow: 0 0 0 2px rgba(67, 97, 238, 0.2);
	}

	#send-button {
		margin-left: 10px;
		width: 50px;
		height: 50px;
		border-radius: 50%;
		background-color: var(--primary-color);
		color: white;
		border: none;
		cursor: pointer;
		display: flex;
		align-items: center;
		justify-content: center;
		font-size: 1.2rem;
		transition: background-color 0.3s, transform 0.2s;
	}

	#send-button:hover {
		background-color: var(--secondary-color);
		transform: scale(1.05);
	}

	#send-button:active {
		transform: scale(0.98);
	}

	.typing-indicator {
		display: none;
		align-items: center;
		margin: 10px 0;
		color: var(--dark-gray);
		font-style: italic;
		animation: fadeIn 0.3s;
	}

	.typing-indicator .dots {
		display: flex;
		margin-left: 8px;
	}

	.typing-indicator .dot {
		width: 8px;
		height: 8px;
		margin: 0 2px;
		background-color: var(--dark-gray);
		border-radius: 50%;
		animation: typing 1.5s infinite ease-in-out;
	}

	.typing-indicator .dot:nth-child(1) {
		animation-delay: 0s;
	}

	.typing-indicator .dot:nth-child(2) {
		animation-delay: 0.3s;
	}

	.typing-indicator .dot:nth-child(3) {
		animation-delay: 0.6s;
	}

	@keyframes typing {
		0% {
			transform: translateY(0px);
			opacity: 0.3;
		}

		50% {
			transform: translateY(-5px);
			opacity: 1;
		}

		100% {
			transform: translateY(0px);
			opacity: 0.3;
		}
	}

	/* Responsive Styles */
	@media (max-width: 768px) {
		.container {
			padding: 10px;
			height: calc(100vh - 60px);
			/* Reduced height for mobile */
		}

		#reset-button {
			width: 38px;
			height: 38px;
		}

		.message {
			max-width: 85%;
		}

		#chat-container {
			/* Limit the height of the chat container on mobile */
			max-height: calc(100vh - 180px);
			flex: 0 1 auto;
			margin-bottom: 15px;
		}
	}

	@media (max-width: 480px) {
		.container {
			padding: 8px;
			height: calc(100vh - 55px);
		}

		#chat-container {
			padding: 10px;
			/* Further restrict on very small screens */
			max-height: calc(100vh - 160px);
		}

		.message {
			max-width: 90%;
			padding: 10px 14px;
		}

		#message-input {
			padding: 12px 16px;
		}

		#send-button {
			width: 44px;
			height: 44px;
		}

		body {
			display: flex;
			flex-direction: column;
		}

		#reset-button {
			width: 36px;
			height: 36px;
		}
	}
</style>
{{- end -}}

{{- define "header_actions" -}}
<button id="reset-button" title="Start new conversation">
	<i class="fa-solid fa-trash"></i>
</button>
{{- end -}}

{{- define "content" -}}
<div id="chat-container">
	<!-- Chat messages will appear here -->
</div>

<div class="typing-indicator" id="typing-indicator">
	<span id="typing-text">{{.AppName}} is typing</span>
	<div class="dots">
		<div class="dot"></div>
		<div class="dot"></div>
		<div class="dot"></div>
	</div>
</div>

<div id="input-container">
	<input type="text" id="message-input" placeholder="Type your message..." autofocus>
	<button id="send-button"><i class="fa-solid fa-paper-plane"></i></button>
</div>
{{- end -}}

{{- define "scripts" -}}
<script>
	const chatContainer = document.getElementById('chat-container');
	const messageInput = document.getElementById('message-input');
	const sendButton = document.getElementById('send-button');
	const typingIndicator = document.getElementById('typing-indicator');
	const typingText = document.getElementById('typing-text');
	let sessionID = localStorage.getItem('sessionID') || '';

	// Set typing indicator text
	typingText.textContent = `{{.AppName}} is typing`;

	// Add event listeners
	sendButton.addEventListener('click', sendMessage);
	messageInput.addEventListener('keypress', function (e) {
		if (e.key === 'Enter') {
			sendMessage();
		}
	});

	// Function to get formatted time
	function getFormattedTime() {
		const now = new Date();
		return now.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
	}

	// Load previous messages if session exists
	function loadSessionMessages() {
		// Clear previous messages first
		chatContainer.innerHTML = '';

		// Load messages from localStorage if they exist
		const storedMessages = localStorage.getItem('chatMessages');
		if (storedMessages) {
			const messages = JSON.parse(storedMessages);
			messages.forEach(msg => {
				addMessageToChat(msg.role, msg.content, false); // Don't save again
			});
		}
	}

	// Function to save messages to localStorage
	function saveMessageToStorage(role, content) {
		let messages = [];
		const storedMessages = localStorage.getItem('chatMessages');
		if (storedMessages) {
			messages = JSON.parse(storedMessages);
		}
		messages.push({role, content});
		localStorage.setItem('chatMessages', JSON.stringify(messages));
	}

	// Function to send message
	function sendMessage() {
		const message = messageInput.value.trim();
		if (message === '') return;

		// Add user message to chat
		addMessageToChat('user', message);
		messageInput.value = '';

		// Show typing indicator
		typingIndicator.style.display = 'flex';

		// Prepare request with sessionID if it exists
		const requestBody = {message};
		if (sessionID) {
			requestBody.session_id = sessionID;
		}

		// Get XSRF token from cookie
		const xsrfToken = getCookie('xsrf_token');

		// Send message to server
		fetch('/api/chat', {
			method: 'POST',
			headers: {
				'Content-Type': 'application/json',
				'X-XSRF-Token': xsrfToken || '',
			},
			body: JSON.stringify(requestBody),
		})
			.then(response => response.json())
			.then(data => {
				// Hide typing indicator
				typingIndicator.style.display = 'none';

				// Save the session ID if it came back from the server
				if (data.session_id) {
					sessionID = data.session_id;
					localStorage.setItem('sessionID', sessionID);
				}

				// Add response to chat
				addMessageToChat(data.message.role, data.message.content);
			})
			.catch(error => {
				console.error('Error:', error);
				typingIndicator.style.display = 'none';
				addMessageToChat('assistant', 'Sorry, there was an error processing your request.');
			});
	}

	// Function to add message to chat
	function addMessageToChat(role, content, saveToStorage = true) {
		const time = getFormattedTime();

		const messageRow = document.createElement('div');
		messageRow.classList.add('message-row');
		if (role === 'user') {
			messageRow.classList.add('user');
		}

		// Create avatar
		const avatar = document.createElement('div');
		avatar.classList.add('avatar');
		avatar.innerHTML = role === 'user' ? '<i class="fa-solid fa-user"></i>' : '<i class="fa-solid fa-building"></i>';

		const messageElement = document.createElement('div');
		messageElement.classList.add('message');
		messageElement.classList.add(role === 'user' ? 'user-message' : 'assistant-message');

		// Create message content
		const messageContent = document.createElement('div');
		messageContent.classList.add('message-content');

		// Use innerHTML for assistant messages to support HTML links
		// Use textContent for user messages for security
		if (role === 'assistant') {
			messageContent.innerHTML = content; // innerHTML to support HTML links
		} else {
			messageContent.textContent = content; // textContent preserves newlines when white-space: pre-wrap is used
		}

		// Create message time
		const messageTime = document.createElement('div');
		messageTime.classList.add('message-time');
		messageTime.textContent = time;

		// Append elements
		messageElement.appendChild(messageContent);
		messageElement.appendChild(messageTime);
		messageRow.appendChild(avatar);
		messageRow.appendChild(messageElement);

		chatContainer.appendChild(messageRow);
		chatContainer.scrollTop = chatContainer.scrollHeight;

		// Save message to localStorage if needed
		if (saveToStorage) {
			saveMessageToStorage(role, content);
		}
	}

	// Function to start a new session
	function startNewSession() {
		// Clear session data
		sessionID = '';
		localStorage.removeItem('sessionID');
		localStorage.removeItem('chatMessages');

		// Clear chat UI
		chatContainer.innerHTML = '';

		// Show welcome message
		setTimeout(() => {
			addMessageToChat('assistant', `Hello! I am {{.AppName}}, your virtual assistant. How can I help you today?`);
		}, 100);
	}

	// Helper function to get a cookie by name
	function getCookie(name) {
		const value = `; ${document.cookie}`;
		const parts = value.split(`; ${name}=`);
		if (parts.length === 2) return parts.pop().split(';').shift();
		return '';
	}

	// Initialize the chat
	window.addEventListener('DOMContentLoaded', () => {
		// Add event listener to reset button
		document.getElementById('reset-button').addEventListener('click', startNewSession);

		// Check if there's an existing session
		if (sessionID) {
			// Load chat history from localStorage
			loadSessionMessages();
		} else {
			// Show welcome message for new users
			setTimeout(() => {
				addMessageToChat('assistant', `Hello! I am {{.AppName}}, your virtual assistant. How can I help you today?`);
			}, 500);
		}
	});
</script>
{{- end -}}
